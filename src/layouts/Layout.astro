---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import WhatsAppButton from "../components/WhatsAppButton.astro";
import "../styles/global.css";
import "../styles/layout.css";

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  noIndex?: boolean;
}

const {
  title = "Química Industrial | Distribución de químicos en Perú",
  description = "Distribuimos materias primas y químicos industriales en Perú. Logística ágil, soporte técnico y catálogo listo para integrarse con tu API de WordPress.",
  canonical,
  noIndex,
} = Astro.props as Props;

let siteOrigin = "https://www.quimicaindustrial.pe";
if (canonical) {
  try {
    siteOrigin = new URL(canonical).origin;
  } catch {
    siteOrigin = "https://www.quimicaindustrial.pe";
  }
}

const ogUrl = canonical ?? siteOrigin;
const ogImage = `${siteOrigin}/images/qi-logo-mobile.png`;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/images/qi-logo-mobile.png" />
    <link rel="apple-touch-icon" href="/images/qi-logo-mobile.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="theme-color" content="#0d47a1" />
    {canonical && <link rel="canonical" href={canonical} />}
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_PE" />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:secure_url" content={ogImage} />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:image:alt" content={title} />
    <meta property="og:site_name" content="Química Industrial Perú" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={title} />

    <!-- Facebook Domain Verification -->
    <meta
      name="facebook-domain-verification"
      content="3cfu4brwsjbg9zhoxqlamjo3zucnhl"
    />

    <!-- Google Tag Manager - DataLayer -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
    </script>

    <!-- Google Tag Manager -->
    <script is:inline>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-TDBJ79DR");
    </script>

    <!-- Meta Pixel Code -->
    <script is:inline>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js",
      );
      fbq("init", "1641103596872444");
      fbq("track", "PageView");
    </script>
    <noscript
      ><img
        height="1"
        width="1"
        style="display:none"
        src="https://www.facebook.com/tr?id=1641103596872444&ev=PageView&noscript=1"
      /></noscript
    >

    <slot name="head" />
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-TDBJ79DR"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <Header />
    <main>
      <slot />
    </main>
    <Footer />
    <WhatsAppButton />

    <script is:inline>
      const CART_STORAGE_KEY = "qi-cart";
      const cartState = {
        items: [],
      };

      const STOCK_LABELS = {
        instock: "En stock",
        outofstock: "Agotado",
        onbackorder: "Disponible bajo pedido",
      };

      const getStockLabel = (status = "") =>
        STOCK_LABELS[status] || "Consultar disponibilidad";

      const getStockClass = (status = "") => {
        switch (status) {
          case "instock":
            return "is-available";
          case "onbackorder":
            return "is-backorder";
          case "outofstock":
            return "is-unavailable";
          default:
            return "is-unknown";
        }
      };

      const loadCart = () => {
        try {
          const stored = window.localStorage.getItem(CART_STORAGE_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed)) {
              cartState.items = parsed.map((entry) => ({
                ...entry,
                quantity: Number(entry.quantity) || 1,
                price: entry.price ?? "",
                priceText: entry.priceText ?? "",
                stockStatus: entry.stockStatus ?? "",
              }));
            }
          }
        } catch (error) {
          console.warn("No se pudo cargar el carrito", error);
        }
      };

      const saveCart = () => {
        try {
          window.localStorage.setItem(
            CART_STORAGE_KEY,
            JSON.stringify(cartState.items),
          );
        } catch (error) {
          console.warn("No se pudo guardar el carrito", error);
        }
      };

      const dispatchCartChange = () => {
        document.dispatchEvent(
          new CustomEvent("qi-cart-change", { detail: cartState }),
        );
      };

      const getCartItemKey = (item) =>
        `${item.productId}__${item.presentationId || ""}`;

      const upsertItem = (item) => {
        const key = getCartItemKey(item);
        const index = cartState.items.findIndex(
          (storedItem) => getCartItemKey(storedItem) === key,
        );
        if (index > -1) {
          const current = cartState.items[index];
          cartState.items[index] = {
            ...current,
            ...item,
            quantity: current.quantity + item.quantity,
          };
        } else {
          cartState.items.push({ ...item });
        }
        cartState.items = cartState.items.filter((entry) => entry.quantity > 0);
        saveCart();
        dispatchCartChange();
      };

      const removeItem = (item) => {
        const key = getCartItemKey(item);
        cartState.items = cartState.items.filter(
          (storedItem) => getCartItemKey(storedItem) !== key,
        );
        saveCart();
        dispatchCartChange();
      };

      const updateQuantity = (item, quantity) => {
        const key = getCartItemKey(item);
        cartState.items = cartState.items.map((storedItem) =>
          getCartItemKey(storedItem) === key
            ? { ...storedItem, quantity: Math.max(1, quantity) }
            : storedItem,
        );
        saveCart();
        dispatchCartChange();
      };

      const renderCart = () => {
        const totalItems = cartState.items.reduce(
          (total, item) => total + item.quantity,
          0,
        );
        document.querySelectorAll("[data-cart-count]").forEach((node) => {
          node.textContent = String(totalItems);
        });

        const cartEmpty = document.querySelector("[data-cart-empty]");
        const itemsContainer = document.querySelector("[data-cart-items]");
        document
          .querySelectorAll("[data-quote-total-items]")
          .forEach((node) => {
            node.textContent = String(totalItems);
          });
        if (itemsContainer) {
          itemsContainer.innerHTML = "";
          if (!cartState.items.length) {
            cartEmpty?.removeAttribute("hidden");
          } else {
            cartEmpty?.setAttribute("hidden", "");
            cartState.items.forEach((item) => {
              const listItem = document.createElement("li");
              listItem.className = "cart-item";
              const priceText = item.priceText || "";
              const stockLabel = getStockLabel(item.stockStatus);
              const stockClass = getStockClass(item.stockStatus);
              listItem.innerHTML = `
                <img src="${item.image}" alt="${item.name}" />
                <div>
                  <h3>${item.name}</h3>
                  ${item.presentation ? `<p class="cart-variant">${item.presentation}</p>` : ""}
                  ${priceText ? `<p class="cart-price">${priceText}</p>` : ""}
                  <p class="cart-stock ${stockClass}">${stockLabel}</p>
                  <p class="cart-quantity">Cantidad: ${item.quantity}</p>
                </div>
                <button type="button" data-action="remove-from-cart" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}">
                  Quitar
                </button>
              `;
              itemsContainer.appendChild(listItem);
            });
          }
        }

        document.querySelectorAll("[data-quote-items]").forEach((node) => {
          node.classList.add("quote-items");
          node.innerHTML = "";
          if (!cartState.items.length) {
            node.innerHTML =
              '<p class="quote-empty">Tu carrito de cotización está vacío.</p>';
            return;
          }

          cartState.items.forEach((item) => {
            const wrapper = document.createElement("article");
            wrapper.className = "quote-item";
            const priceText = item.priceText || "";
            const stockLabel = getStockLabel(item.stockStatus);
            const stockClass = getStockClass(item.stockStatus);
            wrapper.innerHTML = `
              <div class="quote-item__media">
                <img src="${item.image}" alt="${item.name}" />
              </div>
              <div class="quote-item__info">
                <h3>${item.name}</h3>
                ${item.presentation ? `<p class="quote-item__presentation">${item.presentation}</p>` : ""}
                ${priceText ? `<p class="quote-item__price">${priceText}</p>` : ""}
                <p class="quote-item__stock ${stockClass}">${stockLabel}</p>
              </div>
              <div class="quote-item__actions">
                <label>
                  Cantidad
                  <input type="number" min="1" value="${item.quantity}" data-action="update-quantity" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}" />
                </label>
                <button type="button" data-action="remove-from-cart" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}">Eliminar</button>
              </div>
            `;
            node.appendChild(wrapper);
          });
        });

        document.querySelectorAll("[data-cart-empty]").forEach((node) => {
          if (cartState.items.length) {
            node.setAttribute("hidden", "");
          } else {
            node.removeAttribute("hidden");
          }
        });
      };

      const cartApi = {
        add: (item) => upsertItem(item),
        remove: (item) => removeItem(item),
        update: (item, quantity) => updateQuantity(item, quantity),
        clear: () => {
          cartState.items = [];
          saveCart();
          dispatchCartChange();
        },
        getItems: () => cartState.items.map((entry) => ({ ...entry })),
      };

      window.qiCart = cartApi;

      const getPayloadFromNode = (node) => {
        const productId = node.getAttribute("data-product-id");
        const presentationId = node.getAttribute("data-presentation-id") || "";
        const name = node.getAttribute("data-product-name");
        const presentation =
          node.getAttribute("data-product-presentation") || "";
        const image =
          node.getAttribute("data-product-image") || "/images/placeholder.svg";
        const slug = node.getAttribute("data-product-slug");
        const price = node.getAttribute("data-product-price") || "";
        const priceText = node.getAttribute("data-product-price-text") || "";
        const stockStatus =
          node.getAttribute("data-product-stock-status") || "";
        if (!productId || !name) return null;
        return {
          productId,
          presentationId,
          name,
          presentation,
          image,
          slug,
          quantity: Number(node.getAttribute("data-product-quantity")) || 1,
          price,
          priceText,
          stockStatus,
        };
      };

      const getCartOverlay = () =>
        document.querySelector("[data-cart-overlay]");

      const getCartToggle = () => document.querySelector("[data-cart-toggle]");

      const openCartOverlay = () => {
        const overlay = getCartOverlay();
        if (overlay instanceof HTMLElement) {
          overlay.hidden = false;
          document.body.style.overflow = "hidden";
        }
        const toggle = getCartToggle();
        if (toggle instanceof HTMLElement) {
          toggle.setAttribute("aria-expanded", "true");
        }
      };

      const closeCartOverlay = () => {
        const overlay = getCartOverlay();
        if (overlay instanceof HTMLElement) {
          overlay.hidden = true;
          document.body.style.overflow = "";
        }
        const toggle = getCartToggle();
        if (toggle instanceof HTMLElement) {
          toggle.setAttribute("aria-expanded", "false");
        }
      };

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
          return;
        }
        const addTrigger = target.closest('[data-action="add-to-cart"]');
        const removeTrigger = target.closest(
          '[data-action="remove-from-cart"]',
        );
        const openTrigger = target.closest('[data-action="open-cart"]');
        const cartToggle = target.closest("[data-cart-toggle]");
        const closeTrigger = target.closest("[data-cart-close]");
        const cartOverlay = target.closest("[data-cart-overlay]");
        const cartDrawer = target.closest(".cart-drawer");

        if (addTrigger) {
          const payload = getPayloadFromNode(addTrigger);
          if (payload) {
            upsertItem(payload);
            document.dispatchEvent(new CustomEvent("qi-cart-open"));

            // GTM Event: Add to Cart
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
              event: "add_to_cart",
              product_id: payload.productId,
              product_name: payload.name,
              presentation_id: payload.presentationId || null,
              presentation: payload.presentation || null,
              quantity: payload.quantity,
              price: payload.price || null,
            });
          }
        }

        if (removeTrigger) {
          const payload = getPayloadFromNode(removeTrigger);
          if (payload) {
            removeItem(payload);
          }
        }

        if (openTrigger || cartToggle) {
          document.dispatchEvent(new CustomEvent("qi-cart-open"));
        }

        if (closeTrigger) {
          document.dispatchEvent(new CustomEvent("qi-cart-close"));
        }

        // Close cart when clicking on overlay background (not on drawer)
        if (cartOverlay && !cartDrawer) {
          document.dispatchEvent(new CustomEvent("qi-cart-close"));
        }
      });

      document.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
          return;
        }
        const quantityInput = target.closest('[data-action="update-quantity"]');
        if (quantityInput instanceof HTMLInputElement) {
          const payload = getPayloadFromNode(quantityInput);
          if (payload) {
            const value = Number(quantityInput.value) || 1;
            updateQuantity(payload, value);
          }
        }
      });

      document.addEventListener("qi-cart-change", renderCart);
      document.addEventListener("qi-cart-open", openCartOverlay);
      document.addEventListener("qi-cart-close", closeCartOverlay);

      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        dispatchCartChange();
        // Ensure cart is closed on page load
        const overlay = getCartOverlay();
        if (overlay instanceof HTMLElement) {
          overlay.hidden = true;
        }
      });
    </script>
  </body>
</html>
