---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  noIndex?: boolean;
}

const {
  title = "Química Industrial | Distribución de químicos en Lima, Perú",
  description = "Distribuimos materias primas y químicos industriales en Lima, Perú. Logística ágil, soporte técnico y catálogo listo para integrarse con tu API de WordPress.",
  canonical,
  noIndex,
} = Astro.props as Props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="theme-color" content="#0d47a1" />
    {canonical && <link rel="canonical" href={canonical} />}
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_PE" />
  </head>
  <body>
    <Header />
    <main>
      <slot />
    </main>
    <Footer />

    <script is:inline>
      const CART_STORAGE_KEY = "qi-cart";
      const cartState = {
        items: [],
      };

      const loadCart = () => {
        try {
          const stored = window.localStorage.getItem(CART_STORAGE_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed)) {
              cartState.items = parsed;
            }
          }
        } catch (error) {
          console.warn("No se pudo cargar el carrito", error);
        }
      };

      const saveCart = () => {
        try {
          window.localStorage.setItem(
            CART_STORAGE_KEY,
            JSON.stringify(cartState.items),
          );
        } catch (error) {
          console.warn("No se pudo guardar el carrito", error);
        }
      };

      const dispatchCartChange = () => {
        document.dispatchEvent(
          new CustomEvent("qi-cart-change", { detail: cartState }),
        );
      };

      const getCartItemKey = (item) =>
        `${item.productId}__${item.presentationId || ""}`;

      const upsertItem = (item) => {
        const key = getCartItemKey(item);
        const index = cartState.items.findIndex(
          (storedItem) => getCartItemKey(storedItem) === key,
        );
        if (index > -1) {
          cartState.items[index].quantity += item.quantity;
        } else {
          cartState.items.push({ ...item });
        }
        cartState.items = cartState.items.filter((entry) => entry.quantity > 0);
        saveCart();
        dispatchCartChange();
      };

      const removeItem = (item) => {
        const key = getCartItemKey(item);
        cartState.items = cartState.items.filter(
          (storedItem) => getCartItemKey(storedItem) !== key,
        );
        saveCart();
        dispatchCartChange();
      };

      const updateQuantity = (item, quantity) => {
        const key = getCartItemKey(item);
        cartState.items = cartState.items.map((storedItem) =>
          getCartItemKey(storedItem) === key
            ? { ...storedItem, quantity: Math.max(1, quantity) }
            : storedItem,
        );
        saveCart();
        dispatchCartChange();
      };

      const renderCart = () => {
        const totalItems = cartState.items.reduce(
          (total, item) => total + item.quantity,
          0,
        );
        document.querySelectorAll("[data-cart-count]").forEach((node) => {
          node.textContent = String(totalItems);
        });

        const cartEmpty = document.querySelector("[data-cart-empty]");
        const itemsContainer = document.querySelector("[data-cart-items]");
        document
          .querySelectorAll("[data-quote-total-items]")
          .forEach((node) => {
            node.textContent = String(totalItems);
          });
        if (itemsContainer) {
          itemsContainer.innerHTML = "";
          if (!cartState.items.length) {
            cartEmpty?.removeAttribute("hidden");
          } else {
            cartEmpty?.setAttribute("hidden", "");
            cartState.items.forEach((item) => {
              const listItem = document.createElement("li");
              listItem.className = "cart-item";
              listItem.innerHTML = `
                <img src="${item.image}" alt="${item.name}" />
                <div>
                  <h3>${item.name}</h3>
                  ${item.presentation ? `<p class="cart-variant">${item.presentation}</p>` : ""}
                  <p class="cart-quantity">Cantidad: ${item.quantity}</p>
                </div>
                <button type="button" data-action="remove-from-cart" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}">
                  Quitar
                </button>
              `;
              itemsContainer.appendChild(listItem);
            });
          }
        }

        document.querySelectorAll("[data-quote-items]").forEach((node) => {
          node.classList.add("quote-items");
          node.innerHTML = "";
          if (!cartState.items.length) {
            node.innerHTML =
              '<p class="quote-empty">Tu carrito de cotización está vacío.</p>';
            return;
          }

          cartState.items.forEach((item) => {
            const wrapper = document.createElement("article");
            wrapper.className = "quote-item";
            wrapper.innerHTML = `
              <div class="quote-item__media">
                <img src="${item.image}" alt="${item.name}" />
              </div>
              <div class="quote-item__info">
                <h3>${item.name}</h3>
                ${item.presentation ? `<p class="quote-item__presentation">${item.presentation}</p>` : ""}
              </div>
              <div class="quote-item__actions">
                <label>
                  Cantidad
                  <input type="number" min="1" value="${item.quantity}" data-action="update-quantity" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}" />
                </label>
                <button type="button" data-action="remove-from-cart" data-product-id="${item.productId}" data-presentation-id="${item.presentationId || ""}">Eliminar</button>
              </div>
            `;
            node.appendChild(wrapper);
          });
        });

        document.querySelectorAll("[data-cart-empty]").forEach((node) => {
          if (cartState.items.length) {
            node.setAttribute("hidden", "");
          } else {
            node.removeAttribute("hidden");
          }
        });
      };

      const cartApi = {
        add: (item) => upsertItem(item),
        remove: (item) => removeItem(item),
        update: (item, quantity) => updateQuantity(item, quantity),
        clear: () => {
          cartState.items = [];
          saveCart();
          dispatchCartChange();
        },
        getItems: () => cartState.items.map((entry) => ({ ...entry })),
      };

      window.qiCart = cartApi;

      const getPayloadFromNode = (node) => {
        const productId = node.getAttribute("data-product-id");
        const presentationId = node.getAttribute("data-presentation-id") || "";
        const name = node.getAttribute("data-product-name");
        const presentation =
          node.getAttribute("data-product-presentation") || "";
        const image =
          node.getAttribute("data-product-image") || "/images/placeholder.svg";
        const slug = node.getAttribute("data-product-slug");
        if (!productId || !name) return null;
        return {
          productId,
          presentationId,
          name,
          presentation,
          image,
          slug,
          quantity: Number(node.getAttribute("data-product-quantity")) || 1,
        };
      };

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
          return;
        }
        const addTrigger = target.closest('[data-action="add-to-cart"]');
        const removeTrigger = target.closest(
          '[data-action="remove-from-cart"]',
        );
        const openTrigger = target.closest('[data-action="open-cart"]');

        if (addTrigger) {
          const payload = getPayloadFromNode(addTrigger);
          if (payload) {
            upsertItem(payload);
            document.dispatchEvent(new CustomEvent("qi-cart-open"));
          }
        }

        if (removeTrigger) {
          const payload = getPayloadFromNode(removeTrigger);
          if (payload) {
            removeItem(payload);
          }
        }

        if (openTrigger) {
          document.dispatchEvent(new CustomEvent("qi-cart-open"));
        }
      });

      document.addEventListener("change", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
          return;
        }
        const quantityInput = target.closest('[data-action="update-quantity"]');
        if (quantityInput instanceof HTMLInputElement) {
          const payload = getPayloadFromNode(quantityInput);
          if (payload) {
            const value = Number(quantityInput.value) || 1;
            updateQuantity(payload, value);
          }
        }
      });

      document.addEventListener("qi-cart-change", renderCart);

      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        dispatchCartChange();
      });
    </script>

    <style>
      body {
        display: flex;
        flex-direction: column;
      }

      .quote-items {
        display: grid;
        gap: 1rem;
      }

      .quote-item {
        display: grid;
        grid-template-columns: 80px 1fr auto;
        gap: 1rem;
        align-items: center;
        background: var(--color-surface);
        padding: 1rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      }

      .quote-item__media img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: var(--radius-sm);
      }

      .quote-item__actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
      }

      .quote-item__actions input {
        width: 72px;
        padding: 0.35rem 0.5rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
      }

      .quote-item__actions button {
        background: none;
        border: none;
        color: var(--color-muted);
        cursor: pointer;
      }

      .quote-empty {
        padding: 1.5rem;
        border-radius: var(--radius-md);
        background: rgba(148, 163, 184, 0.12);
        text-align: center;
      }

      @media (max-width: 700px) {
        .quote-items {
          display: grid;
          gap: 1rem;
        }

        .quote-item {
          grid-template-columns: 1fr;
          text-align: left;
        }

        .quote-item__media img {
          width: 100%;
          height: 180px;
        }

        .quote-item__actions {
          align-items: flex-start;
          width: 100%;
        }
      }
    </style>
  </body>
</html>
