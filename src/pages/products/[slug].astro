---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/ProductDetail.astro";
import {
  getProducts,
  getCategories,
  getRelatedProducts,
} from "../../data/products";
import type { Product } from "../../data/products";

export async function getStaticPaths() {
  const products = await getProducts();
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  }));
}

interface Props {
  product: Product;
}

const { product } = Astro.props as Props;
const categories = await getCategories();
const relatedProducts = (await getRelatedProducts(product.slug)).filter(
  (item) => item.slug !== product.slug,
);

const getPriceText = (product: Product) => {
  return product.priceText ?? "Consultar precio";
};

const getStockLabel = (status: string) => {
  const STOCK_LABELS = {
    instock: "En stock",
    outofstock: "Agotado",
    onbackorder: "Disponible bajo pedido",
  } as const;
  return (
    STOCK_LABELS[status as keyof typeof STOCK_LABELS] ??
    "Consultar disponibilidad"
  );
};

const getStockClass = (status: string) => {
  switch (status) {
    case "instock":
      return "is-available";
    case "onbackorder":
      return "is-backorder";
    case "outofstock":
      return "is-unavailable";
    default:
      return "is-unknown";
  }
};
---

<Layout
  title={`${product.name} | Química Industrial`}
  description={product.summary}
  canonical={`https://www.quimicaindustrial.pe/products/${product.slug}`}
>
  <ProductDetail product={product} categories={categories} />

  <section class="related-products">
    <div class="container">
      <header class="section-header">
        <div>
          <span class="tag">También te puede interesar</span>
          <h2>Productos relacionados</h2>
        </div>
      </header>
      {
        relatedProducts.length ? (
          <div class="carousel">
            {relatedProducts.map((item) => {
              const presentation = item.presentations[0];
              return (
                <article class="card carousel-item related-card">
                  {item.image ? (
                    <img
                      src={item.image}
                      alt={`Producto ${item.name}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="image-fallback" aria-hidden="true" />
                  )}
                  <div class="related-body">
                    <h3>{item.name}</h3>
                    {item.summary && <p>{item.summary}</p>}
                    <div class="product-pricing">
                      <span class="price">{getPriceText(item)}</span>
                      <span class={`stock ${getStockClass(item.stockStatus)}`}>
                        {getStockLabel(item.stockStatus)}
                      </span>
                    </div>
                  </div>
                  <div class="related-actions">
                    <a class="btn btn-outline" href={`/products/${item.slug}`}>
                      Ver detalle
                    </a>
                    <button
                      class="btn btn-primary"
                      type="button"
                      data-action="add-to-cart"
                      data-product-id={item.id}
                      data-product-name={item.name}
                      data-product-slug={item.slug}
                      data-product-presentation={presentation?.label || ""}
                      data-presentation-id={presentation?.id || ""}
                      data-product-image={item.image}
                      data-product-price={item.price ?? ""}
                      data-product-price-text={item.priceText ?? ""}
                      data-product-stock-status={item.stockStatus}
                    >
                      Agregar
                    </button>
                  </div>
                </article>
              );
            })}
          </div>
        ) : (
          <p class="muted">No encontramos productos relacionados.</p>
        )
      }
    </div>
  </section>
</Layout>
