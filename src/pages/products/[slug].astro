---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/ProductDetail.astro";
import {
  getProducts,
  getCategories,
  getRelatedProducts,
} from "../../data/products";
import type { Product } from "../../data/products";
import "../../styles/pages/product-detail.css";

export async function getStaticPaths() {
  const products = await getProducts();
  return products.map((product) => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;

// Get the product by slug
const product = await getProducts().then((products) =>
  products.find((p) => p.slug === slug),
);

if (!product) {
  return Astro.redirect("/products");
}

// Get categories for this product
const allCategories = await getCategories();
const productCategories = allCategories.filter((cat) =>
  product.categories.includes(cat.id),
);

// Get related products
const relatedProducts = (await getRelatedProducts(product.slug)).filter(
  (item) => item.slug !== product.slug,
);

// No price or stock functions needed
---

<Layout
  title={`${product.name} | QuÃ­mica Industrial`}
  description={product.summary}
  canonical={`https://www.quimicaindustrial.pe/products/${product.slug}`}
>
  <ProductDetail
    product={product}
    categories={productCategories}
    relatedProducts={relatedProducts}
  />
</Layout>
