---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/ProductDetail.astro";
import {
  getProducts,
  getCategories,
  getRelatedProducts,
} from "../../data/products";
import type { Product } from "../../data/products";
import {
  generateProductSchema,
  generateBreadcrumbSchema,
  generateMetaDescription,
  truncateDescription,
} from "../../utils/seo";
import "../../styles/pages/product-detail.css";

export async function getStaticPaths() {
  const products = await getProducts();
  return products.map((product) => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;

// Get the product by slug
const product = await getProducts().then((products) =>
  products.find((p) => p.slug === slug),
);

if (!product) {
  return Astro.redirect("/products");
}

// Get categories for this product
const allCategories = await getCategories();
const productCategories = allCategories.filter((cat) =>
  product.categories.includes(cat.id),
);

// Get related products
const relatedProducts = (await getRelatedProducts(product.slug)).filter(
  (item) => item.slug !== product.slug,
);

// SEO data
const categoryName = productCategories[0]?.name;
const productSchema = generateProductSchema(product, categoryName);
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: "Inicio", url: "https://www.quimicaindustrial.pe" },
  { name: "Productos", url: "https://www.quimicaindustrial.pe/products" },
  { name: product.name },
]);

const metaDescription = truncateDescription(
  generateMetaDescription(product, categoryName),
  160,
);

const ogImage =
  product.image || "https://www.quimicaindustrial.pe/images/qi-logo.png";
const productUrl = `https://www.quimicaindustrial.pe/products/${product.slug}`;
---

<Layout
  title={`${product.name} | Química Industrial`}
  description={metaDescription}
  canonical={productUrl}
>
  <Fragment slot="head">
    <meta property="og:type" content="product" />
    <meta
      property="og:title"
      content={`${product.name} | Química Industrial`}
    />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={productUrl} />
    <meta property="product:brand" content="Química Industrial" />
    <meta property="product:availability" content="in stock" />
    <meta property="product:condition" content="new" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content={`${product.name} | Química Industrial`}
    />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImage} />
    {
      categoryName && (
        <meta
          name="keywords"
          content={`${product.name}, ${categoryName}, químicos industriales, materias primas, Perú`}
        />
      )
    }
    <script
      type="application/ld+json"
      set:html={JSON.stringify(productSchema)}
    />
    <script
      type="application/ld+json"
      set:html={JSON.stringify(breadcrumbSchema)}
    />
  </Fragment>
  <ProductDetail
    product={product}
    categories={productCategories}
    relatedProducts={relatedProducts}
  />
</Layout>

<script define:vars={{ product, categoryName }}>
  // GTM Event: View Product
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: "view_product",
    product_id: product.id,
    product_name: product.name,
    product_slug: product.slug,
    category: categoryName || null,
    page_type: "product_detail",
  });
</script>
